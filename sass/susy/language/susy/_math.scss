// Susy Math
// =========

// Get all the span results
@function span-math(
  $span,
  $location,
  $columns          : $columns,
  $gutters          : $gutters,
  $column-width     : $column-width,
  $layout-method    : $layout-method,
  $layout-math      : $layout-math,
  $flow             : $flow,
  $gutter-place     : $gutter-placement,
  $is-container     : false,
  $gutter-override  : false
) {
  $float            : from($flow);
  $width            : $span;

  $column           : null;
  $padding-before   : null;
  $padding-after    : null;
  $margin-before    : null;
  $margin-after     : null;

  // calculations
  $width: get-span-width($span, $location, $columns, $gutters, $column-width, $layout-math, $gutter-place);

  // gutter location
  $gutter-location  : get-gutters($columns, $gutters, $column-width, $layout-math, $gutter-place, $gutter-override);

  @if $gutter-place == inside {
    @if not $is-container {
      $padding-before: nth($gutter-location,1);
      $padding-after: nth($gutter-location,2);
    }
  } @else {
    $margin-before: nth($gutter-location,1);
    $margin-after: nth($gutter-location,2);
  }

  // special margin handling
  @if $layout-method == isolate {
    $margin-before: get-isolation($span, $location, $columns, $gutters, $column-width, $layout-math);
    $margin-after: -100%;
  } @else {
    @if is-last($span, $location, $columns) {
      $float: to($flow);
      $margin-after: null;
    } @else if is-first($location) {
      $margin-before: null;
    }
  }

  @return $width $float $margin-before $margin-after $padding-before $padding-after $flow;
}

// Return gutter width
@function get-gutter-width(
  $columns        : $columns,
  $gutters        : $gutters,
  $column-width   : $columns-width,
  $layout-math    : $layout-math
) {
  $context  : column-sum($columns, $gutters);
  $gutter   : null;

  @if $layout-math == static {
    @if $column-width {
      $gutter: $gutters * $column-width;
    } @else {
      @warn "Please set a $column-width to use for static output.";
    }
  } @else {
    $gutter: percentage($gutters / $context);
  }

  @return $gutter;
}

@function get-gutters(
  $columns          : $columns,
  $gutters          : $gutters,
  $column-width     : $column-width,
  $layout-math      : $layout-math,
  $gutter-place     : $gutter-placement,
  $gutter-override  : false
) {
  $gutter   : null;
  $before   : null;
  $after    : null;

  @if $gutter-override {
    $gutter: $gutter-override;
  } @else {
    $gutter: get-gutter-width($columns, $gutters, $column-width, $layout-math);
  }

  @if $gutter-place == before {
    $before: $gutter;
  } @else if $gutter-place == after {
    $after: $gutter;
  } @else if $gutter-place == split or $gutter-place == inside {
    $gutter: if($gutter-override, $gutter, $gutter / 2);
    $before: $gutter;
    $after: $gutter;
  }

  @return $before $after;
}

// Return span width
@function get-span-width(
  $span,
  $location,
  $columns        : $columns,
  $gutters        : $gutters,
  $column-width   : $column-width,
  $layout-math    : $layout-math,
  $gutter-place   : $gutter-placement,
  $outer          : null
) {
  $context  : null;
  $span-sum : null;
  $width    : null;

  @if unitless($span) {
    @if $gutter-place == inside {
      $context: column-sum($columns, $gutters, outer);
      $span-sum: column-sum(get-columns($span, $location, $columns), $gutters, outer);
    } @else {
      $context: column-sum($columns, $gutters);
      $outer: if($outer, $gutters, 0);
      $span-sum: get-column-span-sum($span, $location, $columns, $gutters) + $outer;
    }

    @if $layout-math == static {
      $width: $span-sum * $column-width;
    } @else {
      $width: percentage($span-sum / $context);
    }
  } @else {
    $width: $span;
  }

  @return $width;
}

