// Grid Syntax
// ===========
//
// Mixins:
// - set-grid()
// - use-grid()

// Set a new grid using a shorthand
@mixin set-grid(
  $grid,
  $clean: false
) {
  $grid             : parse-grid($grid);

  $new-columns        : nth($grid,1);
  $new-gutters        : nth($grid,2);
  $new-container      : nth($grid,3);
  $new-column-width   : nth($grid,4);
  $new-static         : nth($grid,5);
  $new-flow           : nth($grid,6);

  @if not $clean {
    $columns          : if($new-columns, $new-columns, $columns);
    $gutters          : if($new-gutters, $new-gutters, $gutters);
    $container        : if($new-container, $new-container, $container);
    $column-width     : if($new-column-width, $new-column-width, $column-width);
    $static           : if($new-static, $new-static, $static);
  }

  $columns            : $new-columns;
  $gutters            : $new-gutters;
  $container          : $new-container;
  $column-width       : $new-column-width;
  $static             : $new-static;
  $flow               : if($new-flow, $new-flow, $flow);
}

// Use an arbitrary grid for a section of code
@mixin use-grid(
  $grid,
  $clean: false
) {
  $old-grid: get-grid();

  @include set-grid($grid, $clean);
  @content;
  @include set-grid($old-grid, $clean);
}

// Grid helpers
// ------------

// Get the current grid settings as a shorthand list
@function get-grid(
) {
  $gutter-setting: $gutters;
  $static-setting: false;

  // Use units for column/gutter ratio if available
  @if $column-width {
    $gutter-setting: $column-width $column-width * $gutters;
  }

  // Create keyword for static setting
  @if $static and $static != fluid {
    $static-setting: static;
  } @else {
    $static-setting: fluid;
  }

  // Return grid shorthand
  @return compact($container $columns $gutter-setting $static-setting $flow);
}

// Parse a shorthand grid, and return an ordered list of settings
@function parse-grid(
  $grid: get-grid()
) {
  $columns-setting        : false;
  $gutters-setting        : false;
  $container-setting      : false;
  $column-width-setting   : false;
  $static-setting         : false;
  $flow-setting           : false;
  $columns-check          : false;

  // output: static | fluid
  @if index($grid, static) {
    $static-setting: true;
    $grid: filter($grid, static);
  } @else if index($grid, fluid) {
    $static-setting: false;
    $grid: filter($grid, fluid);
  }

  // flow: rtl | ltr
  @if index($grid, rtl) {
    $flow-setting: rtl;
    $grid: filter($grid, rtl);
  } @else if index($grid, ltr) {
    $flow-setting: ltr;
    $grid: filter($grid, ltr);
  }

  // the remainder
  @each $item in $grid {
    @if type-of($item) == number {
      // container, columns, or gutters
      @if not unitless($item) {
        $container-setting: $item;
      } @else if not $columns-check {
        $columns-setting: $item;
        $columns-check: true;
      } @else {
        $gutters-setting: $item;
      }
    } @else if type-of($item) == list {
      @if unitless(nth($item,1)) {
        $columns-setting: $item;
        $columns-check: true;
      } @else {
        // gutters (with column-width)
        $column-width-setting: nth($item,1);
        $gutters-setting: nth($item,2) / nth($item,1);
      }
    }
  }

  @return $columns-setting $gutters-setting $container-setting $column-width-setting $static-setting $flow-setting;
}

// Return one setting from a shorhand grid
@function get-setting(
  $setting,
  $grid: get-grid()
) {
  $grid     : parse-grid($grid);
  $value    : false;

  $options  : columns gutters container column-width static flow;
  $key      : index($options, $setting);

  @if $key {
    $value: nth($grid, $key);
  }

  @return $value;
}
