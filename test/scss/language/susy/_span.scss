// Span Syntax
// ===========

// test the output of a parsed grid
@mixin test-parsed-span($name, $test, $expect) {
  $expect: map-merge($susy, $expect);

  @each $key, $value in $test {
    $this: map-get($expect, $key);
    @include assert-equal($value, $this,
      '[#{$name}] Returns the correct #{$key}.');
  }
}

@include test-module('Span Syntax') {

  // span [mixin]
  // ------------
  @include output-test('span') {

    // default
    @include assert-setup('default', $grid: 7 .5 after) {
      .test, .expect {
        @include susy-clearfix;
        clear: both;
        .inner { background: rgba(yellow, .25); }
      }
    }
    @include assert-output(
      'Span should set width (75%), float (left), and gutter (5% margin-right)'
    ) {
      .test {
        @include span(5) { .inner { @include span(2); } }
      }
      .expect {
        width: 70%;
        float: left;
        margin-right: 5%;
        .inner {
          width: percentage(2.5/7);
          float: left;
          margin-right: percentage(.5/7);
        }
      }
    }

    // inside
    @include assert-setup('inside', $grid: 8 .25 inside) {
      .test, .expect { clear: both; }
    }
    @include assert-output(
      'Span should set width, float, inside gutter, and border-box'
    ) {
      .test { @include span(5); }
      .expect {
        @include susy-box-sizing(border-box);
        width: 62.5%;
        float: left;
        padding-left: 1.25%;
        padding-right: 1.25%;
      }
    }
  }

  // Span Nesting
  // ------------
  @include test('[mixin] span') {
    $susy: (columns: 12) !global;

    .span-content-test {
      @include span(8 of 12) {
        $test: susy-get(columns);
        $expect: 8;
        @include assert-equal($test, $expect,
          'Span @content should use nested context');

        @include span(3 of 8) {
          $nest-test: susy-get(columns);
          $nest-expect: 3;
          @include assert-equal($nest-test, $nest-expect,
            'Nested span @content should use new nested context');
        }

        $test: susy-get(columns);
        $expect: 8;
        @include assert-equal($test, $expect,
          'Span @content should return to nested context');
      }

      $test: susy-get(columns);
      $expect: 12;
      @include assert-equal($test, $expect,
        'After nesting, column-count should be restored');
    }

    @include original-grid;
  }

  // span [function]
  // ---------------

  @include test('[function] span') {
    @include susy-set((
      columns: 7,
      gutters: .5,
      layout-math: fluid,
    ));

    // simple
    $span: 5;
    $test: span($span);
    $expect: 70%;
    @include assert-equal($test, $expect,
      'Span function returns expected width value.');

    @include original-grid;
  }

  // parse-span
  // ----------

  @include test('[function] parse-span') {
    // Span #1
    $span: first 3 of 12 .25 after isolate fluid ltr wide;
    $test: parse-span($span);
    $expect: (
      span: 3,
      location: first,
      columns: 12,
      gutters: 0.25,
      layout-method: isolate,
      layout-math: fluid,
      spread: wide,
      flow: ltr,
      gutter-position: after,
    );
    @include test-parsed-span('parse-span: #1', $test, $expect);

    // Span #2
    $span: last 4 of (1 2 3 2 1) (4em 1em) before float static rtl container;
    $test: parse-span($span);
    $expect: (
      span: 4,
      location: last,
      columns: (1 2 3 2 1),
      gutters: 0.25,
      column-width: 4em,
      layout-method: float,
      layout-math: static,
      flow: rtl,
      gutter-position: before,
      is-container: container,
    );
    @include test-parsed-span('parse-span: #2', $test, $expect);

    // Span #3
    $span: 1 of 3 alpha split (spread: wider, column-width: 40px);
    $test: parse-span($span);
    $expect: (
      span: 1,
      location: alpha,
      columns: 3,
      column-width: 40px,
      gutter-position: split,
      spread: wider,
    );
    @include test-parsed-span('parse-span: #3', $test, $expect);

    // Span #4
    $span: omega 3 of 7 .5 inside;
    $test: parse-span($span);
    $expect: (
      span: 3,
      location: omega,
      columns: 7,
      gutters: .5,
      gutter-position: inside,
    );
    @include test-parsed-span('parse-span: #4', $test, $expect);

    // Span #5
    $span: 3 at 2 no-gutters;
    $test: parse-span($span);
    $expect: (
      span: 3,
      location: 2,
      gutter-position: no-gutters,
    );
    @include test-parsed-span('parse-span: #5', $test, $expect);

    // Span #6
    $span: 2 gutter 5em;
    $test: parse-span($span);
    $expect: (
      span: 2,
      gutter-override: 5em,
    );
    @include test-parsed-span('parse-span: #6', $test, $expect);

    // Span #7
    $span: 2 of 7 (4em 2em) inside-static;
    $test: parse-span($span);
    $expect: (
      span: 2,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      gutter-position: inside-static,
    );
    @include test-parsed-span('parse-span: #7', $test, $expect);
  }

  // span-get
  // --------

  @include test('[function] span-get') {
    $span: first 3 of 12 (4em 1em) isolate fluid ltr gutters 1em container;
    $pre: parse-span($span);

    // parsing
    $test: span-get(span, $span);
    $expect: span-get(span, $pre);
    @include assert-equal($test, $expect,
      'Span-get should be the same whether pre-parsed or not.');

    // gutter-position (fallback)
    $test: span-get(gutter-position, $pre);
    $expect: map-get($susy-defaults, gutter-position);
    @include assert-equal($test, $expect,
      'Returns the default if a setting is not available.');
  }

  // span math
  // ---------

  @include test('[function] span-math') {
    // after
    $span: (
      span: 5,
      location: 2,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-method: float,
      layout-math: fluid,
      flow: ltr,
      gutter-position: after,
    );
    $span: span-math($span);
    $expect: (
      width: 70%,
      float: from,
      margin_before: null,
      margin_after: 5%,
      padding_before: null,
      padding_after: null,
      flow: ltr,
    );
    @include assert-equal($span, $expect,
      'Returns correct span-math with outside gutters.');

    // inside (padding)
    $span: (
      span: 5,
      location: 2,
      columns: 8,
      gutters: .25,
      column-width: 4em,
      layout-method: float,
      layout-math: fluid,
      flow: ltr,
      gutter-position: inside,
    );
    $span: span-math($span);
    $padding: map-get($span, padding_before) map-get($span, padding_after);
    $expect: 1.25% 1.25%;
    @include assert-equal($padding, $expect,
      'Returns correct padding for inside gutters.');

    // inside (width)
    $span: (
      span: 6,
      location: 2,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-method: float,
      layout-math: static,
      flow: ltr,
      gutter-position: inside,
    );
    $span: span-math($span);
    $width: map-get($span, width);
    $expect: 36em;
    @include assert-equal($width, $expect,
      'Inside-gutter width includes the gutters');

    // wide (width)
    $span: (
      span: 6,
      location: 2,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-method: float,
      layout-math: static,
      spread: wide,
      flow: ltr,
      gutter-position: after,
    );
    $span: span-math($span);
    $width: map-get($span, width);
    $expect: 36em;
    @include assert-equal($width, $expect,
      'wide span width includes the gutters');

    // inside container (padding)
    $span: (
      span: 5,
      location: 2,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-method: float,
      layout-math: fluid,
      flow: ltr,
      gutter-position: inside,
      is-container: container,
    );
    $span: span-math($span);
    $padding: map-get($span, padding_before) map-get($span, padding_after);
    $expect: null null;
    @include assert-equal($padding, $expect,
      'The padding for any "inside container" should be "null null"');

    // isolate (margins)
    $span: (
      span: 3,
      location: 5,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-method: isolate,
      layout-math: fluid,
      flow: ltr,
      gutter-position: after,
    );
    $span: span-math($span);
    $margins: map-get($span, margin_before) map-get($span, margin_after);
    $expect: 60% -100%;
    @include assert-equal($margins, $expect,
      'Returns correction margins for isolation.');

    // after last (margins)
    $span: (
      span: 3,
      location: 5,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-method: float,
      layout-math: static,
      flow: ltr,
      gutter-position: after,
    );
    $span: span-math($span);
    $margins: map-get($span, margin_before) map-get($span, margin_after);
    $float: map-get($span, float);
    $expect: null null;
    @include assert-equal($margins, $expect,
      'Removes correct margins when last.');

    @include assert-equal($float, to,
      'Sets the correct float when last.');

    // before first (margins)
    $span: (
      span: 3,
      location: 1,
      columns: (1 2 3 2 1),
      gutters: .5,
      column-width: 4em,
      layout-method: float,
      layout-math: static,
      flow: ltr,
      gutter-position: before,
    );
    $span: span-math($span);
    $margins: map-get($span, margin_before) map-get($span, margin_after);
    $expect: null null;
    @include assert-equal($margins, $expect,
      'Removes correct margins when first.');
  }

  // get-span-width
  // --------------

  @include test('[function] get-span-width') {
    // explicit
    $span: 30%;
    $map: (span: $span);
    $width: get-span-width($map);
    @include assert-equal($width, $span,
      'Explicit width is returned without changes.');

    // relative
    $map: (
      span: 5,
      location: 1,
      columns: 7,
      gutters: .5,
    );
    $width: get-span-width($map);
    @include assert-equal($width, 70%,
      'Returns correct fluid span width.');

    // relative inside-gutters
    $map: (
      span: 4,
      location: 1,
      columns: 8,
      gutters: .25,
      column-width: null,
      layout-math: fluid,
      gutter-position: inside,
    );
    $width: get-span-width($map);
    @include assert-equal($width, 50%,
      'Returns correct width with inside gutters.');

    // static
    $map: (
      span: 5,
      location: 1,
      columns: 7,
      gutters: .5,
      column-width: 4em,
      layout-math: static,
    );
    $width: get-span-width($map);
    @include assert-equal($width, 28em,
      'Returns the correct static span width.');

    // static inside-gutters
    $map: (
      span: 4,
      location: 1,
      columns: 8,
      gutters: .25,
      column-width: 4em,
      layout-math: static,
      gutter-position: inside,
    );
    $width: get-span-width($map);
    @include assert-equal($width, 20em,
      'Returns the correct static width with inside gutters.');

    // wide
    $map: (
      span: 5,
      location: 1,
      columns: 7,
      gutters: .5,
      spread: wide,
    );
    $width: get-span-width($map);
    @include assert-equal($width, 75%,
      'Returns the correct wide span width.');
  }

  // Get Span Context
  // ----------------

  @include test('[function] get-span-context') {
    $span: 3 of 7 .5 inside static;
    $test: get-span-context($span);
    $expect: (
      columns: 7,
      gutters: .5,
      gutter-position: inside,
      layout-math: static,
    );
    $expect: map-merge($susy-defaults, $expect);
    @include assert-equal($test, $expect,
      'Returns only the grid context of a given span.');
  }
}
